<?php
	namespace App\Controller;
	
	
	class  LedgerbalanceController extends AppController{
		

		
		
		
		public function index()
		{
			
		
		
				$query=$this->Ledgerbalance->Ledgers->find('list',['keyField' => 'LDG_ID','valueField' => 'LDG_NAME']);
			
				$LDG_name = $query->toArray();
		
				 $this->set(compact('LDG_name'));
				 
				 
				 
	

if ($this->request->is(['post','put'])) 
		
			{

		
					
		
	 
		 $id=($this->request->data["name"]);
		 
		

/*search code*/


		



			$date_from=($this->request->data["date_from"]);
			
			
			
			$date_1 = explode('-', $date_from);
			$d = $date_1[0];
			$m = $date_1[1];
			$y = $date_1[2];
			$from_date = $y.'-'.$m.'-'.$d;
			
			/*last month*/
			
			$last_month = explode('-', $date_from);
			$day = $last_month[0];
			$month = $last_month[1];
			$year = $last_month[2];
			$last_m_date = $year.$month;
			
			if($month==1)
			{
				$update_month=12;
				$y=$year-1;
				$last_m_date = $y.$update_month;
			}
			else
			{
			 $last_m_date=$last_m_date-1;
			}
			

/*from date start_date*/					

			$start_date = ("{$y}-{$m}-01");
			
/*last date of from date*/

		$last_date=date('Y-m-d', strtotime('-1 day', strtotime($from_date)));
		
		
			
			$date_last = explode('-', $last_date);
			$d = $date_last[2];
			$m = $date_last[1];
			$y = $date_last[0];
			$before_last_date = $d.'-'.$m.'-'.$y;
			
			
				$this->set(compact('before_last_date'));
				
				

/*end*/	


			$date_to=($this->request->data["date_to"]);
			
			
			
			$date_2 = explode('-', $date_to);
			$d = $date_2[0];
			$m = $date_2[1];
			$y = $date_2[2];
			$to_date = $y.'-'.$m.'-'.$d;
		


			
			$date_between_1=$from_date;	
			$date_between_1=$to_date;




$query=$this->Ledgerbalance->LedgerClosing->find('all')
		->where(['LDG_ID' =>$id])
		->andWhere(['LDG_BAL_PERIOD' =>$last_m_date]);
		$end_balance = $query->toArray();
		$this->set(compact('end_balance'));



/*ladger balance data*/
		
		
				$last_dr=0;
				$last_cr=0;
				$last_balance_date=0;
			foreach($end_balance as $end){
//				echo "<pre>";
	//			var_dump($end);

				
				$last_dr=$end["LBL_BALANCE_DR"];
				$last_cr=$end["LBL_BALANCE_CR"];
				$last_balance_date=$end["LDG_BAL_PERIOD"];
			}
		
		
/*end*/	
					


			
			$query = $this->Ledgerbalance->generalledger->find();
			$query->select(['t_salary' => $query->func()->sum('VCH_DEBIT')])
			->where(['LDG_ID' =>$id])
			->andWhere(['VCH_DATE >=' =>$start_date])
			->andWhere(['VCH_DATE <=' =>$last_date]);
			$total_salary=$query->toArray();
			$this->set(compact('total_salary'));
			
			$voucher_month_first_debit=$total_salary[0]->t_salary;
			
			$this->set(compact('voucher_month_first_debit'));


			
			$query = $this->Ledgerbalance->generalledger->find();
			$query->select(['t_salary' => $query->func()->sum('VCH_CREDIT')])
			->where(['LDG_ID' =>$id])
			->andWhere(['VCH_DATE >=' =>$start_date])
			->andWhere(['VCH_DATE <=' =>$last_date]);
			$total_salary=$query->toArray();
			$this->set(compact('total_salary'));
			
			$voucher_month_second_credit=$total_salary[0]->t_salary;
			
			$this->set(compact('voucher_month_second_credit'));





		$up_to_lastbalance_debit=$last_dr+$voucher_month_first_debit;
		$this->set(compact('up_to_lastbalance_debit'));
		
		
		$up_to_lastbalance_credit=$last_cr+$voucher_month_second_credit;
		$this->set(compact('up_to_lastbalance_credit'));
		
		 

			
			$query = $this->Ledgerbalance->generalledger->find();
			$query->select(['t_salary' => $query->func()->sum('VCH_DEBIT')])
			->where(['LDG_ID' =>$id])
			->andWhere(['VCH_DATE >=' =>$from_date])
			->andWhere(['VCH_DATE <=' =>$to_date]);
			$total_salary=$query->toArray();
			$this->set(compact('total_salary'));
			
		$voucher_month_between_debit=$total_salary[0]->t_salary;
			
			$this->set(compact('voucher_month_first_debit'));
			
			
			
			
				$query = $this->Ledgerbalance->generalledger->find();
			$query->select(['t_salary' => $query->func()->sum('VCH_CREDIT')])
			->where(['LDG_ID' =>$id])
			->andWhere(['VCH_DATE >=' =>$from_date])
			->andWhere(['VCH_DATE <=' =>$to_date]);
			$total_salary=$query->toArray();
			$this->set(compact('total_salary'));
			 $voucher_month_between_credit=$total_salary[0]->t_salary;
			
			$this->set(compact('voucher_month_second_credit'));
			
			

		
			
		
			 

$total_voucher_debit=$voucher_month_between_debit;

$this->set(compact('total_voucher_debit'));


$total_voucher_credit=$voucher_month_between_credit;
	
$this->set(compact('total_voucher_credit'));	
$this->set(compact('up_to_lastbalance_credit'));	
$this->set(compact('up_to_lastbalance_debit'));	

	
	
		
		 $query=$this->Ledgerbalance->generalledger->find('list',['keyField' =>['VCH_ID'],'valueField' => 'VCH_ID'])
		->where(['LDG_ID' =>$id])
		->andWhere(['VCH_DATE >='=>$from_date])
		->andWhere(['VCH_DATE <='=>$to_date]);

		
		 $vch_id = $query->toArray();
	
		 
	
		
		 $query=$this->Ledgerbalance->generalledger->find('all')->contain('vouchers')
		->where(['vouchers.VCH_ID IN' =>$vch_id])
		->andWhere(['vouchers.VCH_STATUS !=' =>STS_DELETED])
		->andWhere(['generalledger.LDG_ID'=>$id])
		->andWhere(['generalledger.VCH_DATE >='=>$from_date])
		->andWhere(['generalledger.VCH_DATE <='=>$to_date])
			->order(['generalledger.VCH_DATE' =>'Asc']);     //->contain('Basicdata');
		//$query->find('all')->contain('Project')->contain('Department')->contain("ledgers");
		
		 $vdt_id = $query->toArray();
		 $this->set(compact('vdt_id'));
		 
		 
		 
		 
		 
				$query=$this->Ledgerbalance->Ledgers->find('all')
				->where(['LDG_ID' =>$id]);
				$LDG_ACC_TYPE = $query->toArray();
				 $type=$LDG_ACC_TYPE["0"]["LDG_ACC_TYPE"];
				
				  $this->set(compact('type'));
		

		
					
			
			}
		}
		
		
	
		
		
		
		
		
		
		
		
	  public function view($VCH_ID)
    {
        if (!$VCH_ID) 
		{
            throw new NotFoundException(__('Invalid user'));
        }
		
	
		 
		
		 $query=$this->Ledgerbalance->find('all')->contain('vouchers')
		->where(['vouchers.VCH_ID IN' =>$VCH_ID]); //->contain('Basicdata');
		
		$query->find('all')->contain('Project')->contain('Department')->contain('Ledgers');
		
		 $vdt_id = $query->toArray();
		 $this->set(compact('vdt_id'));
		 
		 
		 
		 
		 
		$query = $this->Ledgerbalance->find();
		$query->select(['t_salary' => $query->func()->sum('VDT_DEBIT')])
		->where(['VCH_ID IN' =>$VCH_ID]);
		$total_debit=$query->toArray();
		$this->set(compact('total_debit'));

		$debit=$total_debit[0]->t_salary;
		
		$this->set(compact('debit'));
		
		 
		 
		
		
					$query = $this->Ledgerbalance->find();
		$query->select(['t_salary' => $query->func()->sum('VDT_CREDIT')])
		->where(['VCH_ID IN' =>$VCH_ID]);
		$total_credit=$query->toArray();
		$this->set(compact('total_credit'));

		$credit=$total_credit[0]->t_salary;
		
		$this->set(compact('credit'));
		
		 
		 
		
		
    }
	
	
	
	
	
	
	 public function printer($VCH_ID)
    {
        if (!$VCH_ID) 
		{
            throw new NotFoundException(__('Invalid user'));
        }
		
	
		 
		
		 $query=$this->Ledgerbalance->find('all')->contain('vouchers')
		->where(['vouchers.VCH_ID IN' =>$VCH_ID]); //->contain('Basicdata');
		
		$query->find('all')->contain('Project')->contain('Department')->contain('Ledgers');
		
		 $vdt_id = $query->toArray();
		 $this->set(compact('vdt_id'));
		 
		 
		 
		 
		 
		$query = $this->Ledgerbalance->find();
		$query->select(['t_salary' => $query->func()->sum('VDT_DEBIT')])
		->where(['VCH_ID IN' =>$VCH_ID]);
		$total_debit=$query->toArray();
		$this->set(compact('total_debit'));

		$debit=$total_debit[0]->t_salary;
		
		$this->set(compact('debit'));
		
		 
		 
		
		
					$query = $this->Ledgerbalance->find();
		$query->select(['t_salary' => $query->func()->sum('VDT_CREDIT')])
		->where(['VCH_ID IN' =>$VCH_ID]);
		$total_credit=$query->toArray();
		$this->set(compact('total_credit'));

		$credit=$total_credit[0]->t_salary;
		
		$this->set(compact('credit'));
		
		 
		 
		
		
    }
		
	
	
	
	
	
		
		
	}

?>